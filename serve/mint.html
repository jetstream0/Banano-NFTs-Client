<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Mint a NFT</title>
    <link href="/mint.css" rel="stylesheet" type="text/css" />
    <script src="/banano.js"></script>
    <script src="/b68.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"><style type="text/css">
<!--
body {
	background-image: url(../images/GL1.png);
}
.style2 {color: #FFFF00}
.style3 {
	color: #FFFFFF;
	font-weight: bold;
}
.style4 {font-weight: bold}
-->
  </style>
  
  <style type="text/css">
div.test
{
    width: 100%;
	background-image:url(../images/textBG.png);
    padding: 1px;
    border: 2px solid #000;
    border-radius: 15px;
    -moz-border-radius: 15px;
}
div.test1 {    width: 100%;
	background-image:url(../images/textBG.png);
    padding: 1px;
    border: 2px solid #000;
    border-radius: 15px;
    -moz-border-radius: 15px;
}
div.test11 {width: 100%;
	background-image:url(../images/textBG.png);
    padding: 1px;
    border: 2px solid #000;
    border-radius: 15px;
    -moz-border-radius: 15px;
}
  </style>
  </head>
  <body>
    <!--example:
    {
  "name": "r/place BANANO 2022",
  "image": "QmVvAhBftbWg6pAR36Gg5DWzi2YBdGDXoHHBjsndzJV1i8",
  "animation_url": "QmTza4eYsyzBoZo1a3BEWVzfCgeXGH8np3Qt8VPcPQyxk4",
  "description": "Participation token for BANANO contributors on r/place in 2022.\n\n538 contributors were selected at random by checking pixels manually and from users who actively facilitated communication.\n\nThe artwork is an artistic interpretation of the first collaboration at (200, 910).",
  "properties": {
    "issuer": "ban_1rp1aceaawpub5zyztzs4tn7gcugm5bc3o6oga16bb18bquqm1bjnoomynze",
    "supply_block_hash": "079871683378A92059E87A4BABFABCCC066ED529D53D4474541836267CF19AAF"
  }
}
    -->
    <!--
      Name, Image, Animation Url (optional), Description, Seed, Supply, Pinata Api Key
      With seed, send supply block. Then upload image/animation, and generate json, upload json. 
    -->
    <div id="result-success" style="display: none;">
      <p style="background-color:#FFFF00">Success: Set the account's (account should be the one from the seed inputted) rep to <span id="nft-rep"></span> during the send and the NFT will mint+send.</p>
    </div>
    <div id="result-failure" style="display: none;">
      <p style="background-color:#FF0000">Process Failed</p>
    </div>
	
	<table width="100%" border="0" cellpadding="3" cellspacing="3">
      <tr>
        <td width="15%">
          <blockquote>
            <p><img src="../images/pru2.png" width="111" height="166"></p>
          </blockquote>
        </td>
        <td width="85%" colspan="3"><div class="test11" style="border-color:#FFFF00">
          <blockquote class="style3"><a href="../serve/mint.html" style="color:#FFFF00">Mint NFT</a> <span class="style2">—</span> <a href="../serve/support.html" style="color:#FFFF00">Support</a> <span class="style2">—</span> <a href="https://faucet.prussia.dev" style="color:#FFFF00">Prussia Faucet</a> </blockquote>
        </div></td>
      </tr>
      <tr>
        <td width="15%" colspan="2" rowspan="2" valign="top"><div class="test" style="border-color:#FFFFFF">
		
		
		
		<div id="nft-upload">
		  <br>
		  <span class="style3">
		  <blockquote>
		    <p>Pinata API Key: </p>
          </blockquote>
		  </span>
    <blockquote>
      <p><span class="style3">
            <input border="yellow" type="text" id="api-key">
            </input>
      </span></p>
    </blockquote>
    <span class="style3"><blockquote>
      <p>Pinata API Secret: </p>
    </blockquote>
    </span>
    <blockquote>
      <p><span class="style3">
        <input type="text" id="api-secret">
        </input>
      </span></p>
    </blockquote>
    <span class="style3"><blockquote>
      <p>Name: </p>
    </blockquote>
    </span>
    <blockquote>
      <p><span class="style3">
        <input id="name" type="text">
        </input>
      </span></p>
    </blockquote>
    <span class="style3"><blockquote>
      <p>Description: </p>
    </blockquote>
    </span>
    <blockquote>
      <p id="description"><span class="style3">
        <textarea id="description"></textarea>
      </span></p>
    </blockquote>
    <span class="style3"><blockquote>
      <p>Banano Seed: </p>
    </blockquote>
    </span>
    <blockquote>
      <p><span class="style3">
        <input type="text" id="seed">
        </input>
      </span></p>
      <p><span class="style3"><br>
        <!--Image upload-->
        <input type="file" id="file-upload" accept="image/*">
      </span></p>
    </blockquote>
    <span class="style3"><blockquote>
      <p>Max Supply (0 for unlimited): </p>
    </blockquote>
    </span>
    <blockquote>
      <p><span class="style3">
        <input type="text" id="supply">
        </input>
          </span></p>
      <button class="style4" onClick="mint()">Mint</button>
    </blockquote>
	<br>
        </div></div>
    <!--Give mint rep--></td>
        <td width="45%" valign="top"><div class="test" style="border-color:#FFFF00"><div>
           
              <p align="left" class="style2"><br> <blockquote><span class="style2"><b>Things to check:</b></span>         
                </p>
            </blockquote>
          <ul>
      <li class="style2">Get your key and secret at https://pinata.cloud?</li>
      <li class="style2">Did you upload a file?</li>
      <li class="style2">Check for trailing spaces</li>
      <li class="style2">Make sure account is opened</li>
      <li class="style2">Are all fields filled?</li>
      <li class="style2">What device are you using?</li>
      <li class="style2">Check the developer console</li>
      <li class="style2">Make sure 'pinfile' and 'pinjson' endpoint permissions were allowed in</li>
      <li class="style2">Check for pinata keys unlimited uses</li>
      <li class="style2">Make sure to contact me (prussia) after minting, I will need to whitelist the minting address</li>
      </ul>
          <p>&nbsp;</p>
        </div></div></td>
        <td width="40%" colspan="2" rowspan="2" valign="top">&nbsp;</td>
      </tr>
      <tr>
        <td valign="top">&nbsp;</td>
      </tr>
      <tr>
        <td colspan="5">&nbsp;</td>
      </tr>
    </table>
  
    <br>
    <p>&nbsp;    </p>
    <p>
      <script>
      const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
      window.bananocoinBananojs.setBananodeApiUrl('https://kaliumapi.appditto.com/api');
      async function pin_json(json_data) {
        let api_key = document.getElementById('api-key').value;
        let api_secret = document.getElementById('api-secret').value;
        let json_resp = await fetch("https://api.pinata.cloud/pinning/pinJSONToIPFS", {
          method: 'POST',
          body: JSON.stringify(json_data),
          headers: {
            'Content-Type': 'application/json;charset=utf-8',
            pinata_api_key: api_key,
            pinata_secret_api_key: api_secret
          }
        });
        json_resp = await json_resp.json();
        console.log(json_resp)
        if (json_resp.IpfsHash) {
          return json_resp.IpfsHash;
        } else {
          return false;
        }
      }
      async function pin_images() {
        //get image
        let file_input = document.getElementById('file-upload');
        file = file_input.files[0];
        let data = new FormData();
        //get api key and api secret
        let api_key = document.getElementById('api-key').value;
        let api_secret = document.getElementById('api-secret').value;
        //pin to ipfs using pinata api
        //stream()
        data.append('file', file, 'ban_nft.png');
        data.append('pinataOptions', JSON.stringify({cidVersion: 0}));
        let img_resp = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
          method: 'POST',
          body: data,
          headers: {
            //'Content-Type': `multipart/form-data; boundary=${data._boundary}`,
            pinata_api_key: api_key,
            pinata_secret_api_key: api_secret
          }
        });
        img_resp = await img_resp.json();
        console.log(img_resp)
        if (img_resp.IpfsHash) {
          return img_resp.IpfsHash;
        } else {
          return false;
        }
      }
      async function mint() {
        let supply = Number(document.getElementById('supply').value);
        let seed = document.getElementById('seed').value.trim();
        let ban_address = await window.bananocoinBananojs.getBananoAccountFromSeed(seed, 0);
        if (!ban_address) {
          //ERROR
          document.getElementById('result-failure').style.display = "block";
          return;
        }
        //create supply block by creating public key
        //get versions
        let major_version = 1;
        let mv_pub = major_version.toString(16);
        mv_pub = "0".repeat(10-mv_pub.length)+mv_pub;
        let minor_version = 0;
        let mn_pub = minor_version.toString(16);
        mn_pub = "0".repeat(10-mn_pub.length)+mn_pub;
        let patch_version = 0;
        let pt_pub = patch_version.toString(16);
        pt_pub = "0".repeat(10-pt_pub.length)+pt_pub;
        //get supply
        let supply_pub = supply.toString(16);
        supply_pub = "0".repeat(16-supply_pub.length)+supply_pub;
        let s_pub_key = '51BACEED6078000000'+mv_pub+mn_pub+pt_pub+supply_pub;
        let supply_rep = window.bananocoinBananojs.getBananoAccount(s_pub_key);
        //SET REP, which creates the supply block
        await sleep(500);
        let supply_block_hash = await window.bananocoinBananojs.changeBananoRepresentativeForSeed(seed, 0, supply_rep);
        //upload images
        let img_hash = await pin_images();
        if (!img_hash) {
          //ERROR
          document.getElementById('result-failure').style.display = "block";
          return;
        }
        await sleep(500);
        //create json text
        let json_info = {};
        json_info.name = document.getElementById('name').value;
        json_info.image = img_hash;
        json_info.description = document.getElementById('description').value;
        json_info.properties = {
          issuer: ban_address,
          supply_block_hash: supply_block_hash
        };
        console.log(json_info)
        let json_hash = await pin_json(json_info);
        if (!json_hash) {
          //ERROR
          document.getElementById('result-failure').style.display = "block";
          return;
        }
        //cid to account
        let MAP = "123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"; 
        let decoded = toHexString(from_b58(json_hash,MAP)).toUpperCase(); 
        //remove 1220
        let nft_rep_pub = decoded.slice(4);
        let nft_rep_addr = window.bananocoinBananojs.getAccount(nft_rep_pub, "ban_");
        document.getElementById('result-success').style.display = "block";
        document.getElementById('nft-rep').innerText = nft_rep_addr;
      }
    </script>
      </p>
  </body>
</html>